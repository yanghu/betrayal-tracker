<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>山中小屋 角色属性追踪器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .stat-value {
            transition: all 0.2s ease-in-out;
        }
        .current-value {
            transform: scale(1.2);
            font-weight: 700;
        }
        .start-value {
            text-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
        }
        .skull-value {
             filter: drop-shadow(0 0 3px rgba(239, 68, 68, 0.7));
        }
        .btn-disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .character-card {
             cursor: pointer;
        }
        .toggle-bg {
            transition: background-color 0.2s ease-in-out;
        }
        #confirmation-modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">

    <div id="app" class="container mx-auto p-4 max-w-lg">

        <!-- 角色选择界面 -->
        <div id="selection-screen" class="hidden">
            <header class="text-center mb-6 relative">
                <h1 class="text-3xl font-bold text-red-500 tracking-wider">山中小屋</h1>
                <p class="text-xl text-gray-300">角色属性追踪器</p>
                <button id="reset-app-button" title="重置所有数据" class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16" />
                    </svg>
                </button>
            </header>
            <div id="character-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- 角色卡片将由JS动态生成 -->
            </div>
        </div>

        <!-- 属性追踪界面 -->
        <div id="tracker-screen" class="hidden">
            <header class="flex items-center justify-between mb-4">
                <button id="back-to-selection" class="text-blue-400 hover:text-blue-300 transition-colors">&lt; 返回选择</button>
                <div class="flex items-center space-x-2">
                    <span id="haunt-label" class="text-gray-400 text-sm transition-colors duration-200">作祟开始?</span>
                    <label for="haunt-toggle" class="flex items-center cursor-pointer">
                        <div class="relative">
                            <input type="checkbox" id="haunt-toggle" class="sr-only">
                            <div id="haunt-toggle-bg" class="toggle-bg block bg-gray-600 w-10 h-6 rounded-full"></div>
                            <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                        </div>
                    </label>
                </div>
            </header>
            
            <div id="character-header" class="text-center p-4 rounded-lg mb-6">
                <h2 id="character-name" class="text-2xl font-bold"></h2>
            </div>

            <div id="stats-container" class="space-y-4">
                <!-- 属性条将由JS动态生成 -->
            </div>
             <footer class="text-center mt-8">
                <p id="character-status" class="text-xl font-bold text-red-500 h-8"></p>
            </footer>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden opacity-0">
            <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center shadow-lg">
                <h3 class="text-lg font-bold mb-4">确认操作</h3>
                <p id="modal-message" class="text-gray-300 mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="modal-cancel" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition-colors w-24">取消</button>
                    <button id="modal-confirm" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition-colors w-24">确认</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const STORAGE_KEY = 'betrayalGameState';

        const characters = [
            { name: "Darrin Williams (飞毛腿)", color: "border-red-500", bgColor: "bg-red-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 5, 6, 6, 7], start: 4 }, speed: { name: "速度", scale: ['💀', 4, 4, 4, 5, 6, 7, 7, 8], start: 4 }, knowledge: { name: "知识", scale: ['�', 2, 3, 3, 4, 5, 5, 5, 7], start: 4 }, sanity: { name: "神志", scale: ['💀', 1, 2, 3, 4, 5, 5, 5, 7], start: 4 }}},
            { name: "Ox Bellows (莽撞大汉)", color: "border-red-500", bgColor: "bg-red-900", stats: { might: { name: "力量", scale: ['💀', 4, 5, 5, 6, 6, 7, 8, 8], start: 4 }, speed: { name: "速度", scale: ['💀', 2, 2, 2, 3, 4, 5, 5, 6], start: 4 }, knowledge: { name: "知识", scale: ['💀', 2, 2, 2, 3, 3, 5, 5, 6], start: 4 }, sanity: { name: "神志", scale: ['💀', 2, 2, 3, 4, 5, 5, 6, 7], start: 4 }}},
            { name: "Prof. Longfellow (睿智教授)", color: "border-green-500", bgColor: "bg-green-900", stats: { might: { name: "力量", scale: ['💀', 1, 2, 2, 3, 4, 5, 6, 7], start: 3 }, speed: { name: "速度", scale: ['💀', 2, 3, 3, 4, 5, 6, 7, 8], start: 3 }, knowledge: { name: "知识", scale: ['💀', 4, 5, 5, 6, 7, 8, 8, 8], start: 3 }, sanity: { name: "神志", scale: ['💀', 1, 3, 3, 4, 5, 6, 7, 8], start: 3 }}},
            { name: "Father Rhinehardt (莱因哈特神父)", color: "border-green-500", bgColor: "bg-green-900", stats: { might: { name: "力量", scale: ['💀', 1, 2, 2, 4, 4, 5, 5, 6], start: 3 }, speed: { name: "速度", scale: ['💀', 2, 3, 3, 4, 5, 6, 7, 7], start: 3 }, knowledge: { name: "知识", scale: ['💀', 1, 3, 3, 4, 5, 6, 8, 8], start: 4 }, sanity: { name: "神志", scale: ['💀', 3, 4, 5, 5, 6, 7, 8, 8], start: 5 }}},
            { name: "Brandon Jaspers (阳光少年)", color: "border-blue-500", bgColor: "bg-blue-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 5, 6, 7, 8], start: 4 }, speed: { name: "速度", scale: ['💀', 3, 4, 4, 4, 5, 6, 7, 8], start: 3 }, knowledge: { name: "知识", scale: ['💀', 1, 3, 3, 5, 5, 6, 6, 7], start: 4 }, sanity: { name: "神志", scale: ['💀', 3, 3, 3, 4, 5, 6, 7, 8], start: 3 }}},
            { name: "Peter Akimoto (日本男孩)", color: "border-blue-500", bgColor: "bg-blue-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 5, 5, 6, 8], start: 3 }, speed: { name: "速度", scale: ['💀', 3, 3, 3, 4, 6, 6, 7, 7], start: 4 }, knowledge: { name: "知识", scale: ['💀', 3, 4, 4, 5, 6, 7, 7, 8], start: 3 }, sanity: { name: "神志", scale: ['💀', 3, 4, 4, 5, 6, 6, 7, 8], start: 3 }}},
            { name: "Zoe Ingstrom (古怪女孩)", color: "border-yellow-400", bgColor: "bg-yellow-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 4, 5, 6, 8], start: 4 }, speed: { name: "速度", scale: ['💀', 3, 3, 4, 4, 4, 5, 6, 8], start: 3 }, knowledge: { name: "知识", scale: ['💀', 1, 2, 3, 4, 4, 5, 5, 5], start: 3 }, sanity: { name: "神志", scale: ['💀', 3, 4, 5, 5, 6, 6, 7, 8], start: 2 }}},
            { name: "Missy Dubourde (邻家女孩)", color: "border-yellow-400", bgColor: "bg-yellow-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 3, 4, 5, 6, 7], start: 3 }, speed: { name: "速度", scale: ['💀', 3, 4, 4, 5, 6, 6, 6, 7], start: 2 }, knowledge: { name: "知识", scale: ['💀', 2, 3, 4, 4, 5, 6, 6, 6], start: 3 }, sanity: { name: "神志", scale: ['💀', 1, 2, 3, 4, 5, 5, 6, 7], start: 4 }}},
            { name: "Madame Zostra (占卜师)", color: "border-gray-200", bgColor: "bg-gray-700", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 5, 5, 6, 7], start: 3 }, speed: { name: "速度", scale: ['💀', 2, 3, 3, 4, 5, 6, 6, 7], start: 4 }, knowledge: { name: "知识", scale: ['💀', 1, 3, 4, 4, 4, 5, 6, 7], start: 3 }, sanity: { name: "神志", scale: ['💀', 4, 4, 4, 5, 6, 7, 8, 8], start: 4 }}},
            { name: "Vivian Lopez (拉丁女郎)", color: "border-gray-200", bgColor: "bg-gray-700", stats: { might: { name: "力量", scale: ['💀', 2, 2, 2, 4, 4, 5, 6, 6], start: 4 }, speed: { name: "速度", scale: ['💀', 3, 4, 4, 4, 4, 6, 7, 8], start: 3 }, knowledge: { name: "知识", scale: ['💀', 4, 5, 5, 5, 5, 6, 6, 8], start: 2 }, sanity: { name: "神志", scale: ['💀', 1, 2, 3, 4, 4, 5, 6, 6], start: 4 }}},
            { name: "Jenny LeClerc (坚强女孩)", color: "border-purple-500", bgColor: "bg-purple-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 4, 5, 6, 8], start: 3 }, speed: { name: "速度", scale: ['💀', 2, 3, 4, 4, 4, 5, 6, 8], start: 3 }, knowledge: { name: "知识", scale: ['💀', 1, 2, 3, 4, 4, 5, 6, 8], start: 4 }, sanity: { name: "神志", scale: ['💀', 3, 4, 4, 4, 5, 6, 7, 8], start: 5 }}},
            { name: "Heather Granville (高傲贵妇)", color: "border-purple-500", bgColor: "bg-purple-900", stats: { might: { name: "力量", scale: ['💀', 2, 3, 3, 4, 5, 6, 7, 8], start: 3 }, speed: { name: "速度", scale: ['💀', 3, 3, 4, 5, 6, 7, 8, 8], start: 2 }, knowledge: { name: "知识", scale: ['💀', 2, 3, 4, 5, 6, 7, 8, 8], start: 4 }, sanity: { name: "神志", scale: ['💀', 2, 3, 3, 4, 5, 6, 7, 8], start: 5 }}},
        ];

        let state = {
            selectedCharacterIndex: null,
            hauntStarted: false,
            currentStatIndices: null
        };

        const selectionScreen = document.getElementById('selection-screen');
        const trackerScreen = document.getElementById('tracker-screen');
        const characterList = document.getElementById('character-list');
        const characterNameEl = document.getElementById('character-name');
        const characterHeaderEl = document.getElementById('character-header');
        const statsContainer = document.getElementById('stats-container');
        const backButton = document.getElementById('back-to-selection');
        const hauntToggle = document.getElementById('haunt-toggle');
        const hauntToggleBg = document.getElementById('haunt-toggle-bg');
        const hauntLabel = document.getElementById('haunt-label');
        const characterStatusEl = document.getElementById('character-status');
        const hauntToggleDot = document.querySelector('label[for="haunt-toggle"] .dot');
        const resetAppButton = document.getElementById('reset-app-button');
        const modal = document.getElementById('confirmation-modal');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');
        
        function saveState() {
            try {
                if (state.selectedCharacterIndex !== null) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                    console.log('State Saved:', JSON.stringify(state));
                } else {
                    localStorage.removeItem(STORAGE_KEY);
                    console.log('State Cleared.');
                }
            } catch (error) {
                console.error("Failed to save state:", error);
            }
        }

        function resetApp() {
            console.log('Resetting application state.');
            state = { selectedCharacterIndex: null, hauntStarted: false, currentStatIndices: null };
            saveState();
            renderSelectionScreen();
        }

        function renderSelectionScreen() {
            characterList.innerHTML = '';
            const displayOrder = [0, 1, 6, 7, 2, 3, 4, 5, 10, 11, 8, 9];
            const orderedCharacters = displayOrder.map(i => ({...characters[i], originalIndex: i}));
            orderedCharacters.forEach(charData => {
                const card = document.createElement('div');
                card.className = `character-card p-4 rounded-lg transition-all duration-200 transform hover:scale-105 border-2 ${charData.color} ${charData.bgColor}`;
                card.dataset.index = charData.originalIndex;
                card.innerHTML = `<h3 class="font-bold text-center text-lg">${charData.name}</h3>`;
                characterList.appendChild(card);
            });
            trackerScreen.classList.add('hidden');
            selectionScreen.classList.remove('hidden');
        }

        function renderTrackerScreen() {
            if (state.selectedCharacterIndex === null) {
                console.warn('renderTrackerScreen called with no character selected.');
                renderSelectionScreen();
                return;
            };
            const character = characters[state.selectedCharacterIndex];
            characterNameEl.textContent = character.name;
            characterHeaderEl.className = `text-center p-4 rounded-lg mb-6 border-2 ${character.color} ${character.bgColor}`;
            statsContainer.innerHTML = '';
            let isDead = false;
            for (const statKey in character.stats) {
                const statData = character.stats[statKey];
                const currentIndex = state.currentStatIndices[statKey];
                if (currentIndex === 0) { isDead = true; }
                const statWrapper = document.createElement('div');
                statWrapper.className = `p-3 rounded-lg bg-gray-800 border border-gray-700`;
                let valuesHTML = statData.scale.map((value, index) => {
                    const isCurrent = index === currentIndex;
                    const isStart = index === statData.start;
                    const isSkull = index === 0;
                    let classes = 'stat-value inline-block text-center w-8 h-8 leading-8 rounded-full text-gray-400';
                    if (isCurrent) classes += ' current-value text-white bg-gray-600';
                    if (isStart) classes += ' start-value text-green-400';
                    if(isSkull) classes += ' skull-value text-red-500';
                    return `<div class="${classes}">${value}</div>`;
                }).join('');
                const canDecrease = state.hauntStarted ? currentIndex > 0 : currentIndex > 1;
                const canIncrease = currentIndex < statData.scale.length - 1;
                statWrapper.innerHTML = `<div class="flex justify-between items-center mb-3"><h4 class="text-lg font-bold">${statData.name}</h4><div class="flex items-center space-x-2"><button class="bg-red-600 text-white rounded-full w-8 h-8 font-bold text-2xl leading-none flex items-center justify-center ${!canDecrease ? 'btn-disabled' : 'hover:bg-red-500'}" data-stat="${statKey}" data-op="decrease" ${!canDecrease ? 'disabled' : ''}>-</button><button class="bg-green-600 text-white rounded-full w-8 h-8 font-bold text-2xl leading-none flex items-center justify-center ${!canIncrease ? 'btn-disabled' : 'hover:bg-green-500'}" data-stat="${statKey}" data-op="increase" ${!canIncrease ? 'disabled' : ''}>+</button></div></div><div class="flex justify-center space-x-1 flex-wrap">${valuesHTML}</div>`;
                statsContainer.appendChild(statWrapper);
            }
            characterStatusEl.textContent = isDead ? '角色已死亡' : '';
            hauntToggle.checked = state.hauntStarted;
            if (state.hauntStarted) {
                hauntToggleBg.classList.replace('bg-gray-600', 'bg-red-600');
                hauntLabel.classList.replace('text-gray-400', 'text-red-500');
                hauntToggleDot.style.transform = 'translateX(100%)';
            } else {
                hauntToggleBg.classList.replace('bg-red-600', 'bg-gray-600');
                hauntLabel.classList.replace('text-red-500', 'text-gray-400');
                hauntToggleDot.style.transform = 'translateX(0)';
            }
            selectionScreen.classList.add('hidden');
            trackerScreen.classList.remove('hidden');
        }
        
        function showModal(message, confirmAction) {
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            modalConfirm.onclick = () => {
                confirmAction();
                hideModal();
            };
        }

        function hideModal() {
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modalConfirm.onclick = null;
            }, 300);
        }

        function initializeCharacterState(index) {
            console.log(`Initializing state for character index: ${index}`);
            state.selectedCharacterIndex = index;
            const character = characters[index];
            state.currentStatIndices = {};
            for (const statKey in character.stats) {
                state.currentStatIndices[statKey] = character.stats[statKey].start;
            }
            state.hauntStarted = false;
            saveState();
            renderTrackerScreen();
        }
        
        function handleCharacterSelection(e) {
            const card = e.target.closest('.character-card');
            if (!card) return;
            const index = parseInt(card.dataset.index, 10);

            if (state.selectedCharacterIndex !== null && index !== state.selectedCharacterIndex) {
                showModal(
                    "选择新角色将会清空当前角色的进度。确定要继续吗？",
                    () => initializeCharacterState(index)
                );
            } else if (state.selectedCharacterIndex === null) {
                initializeCharacterState(index);
            } else if (index === state.selectedCharacterIndex) {
                console.log(`Resuming session with character index: ${index}`);
                renderTrackerScreen();
            }
        }

        function handleBackToSelection() {
             showModal(
                "确定要结束本次追踪并返回主菜单吗？",
                () => {
                    console.log("Session ended by user. Clearing state.");
                    resetApp();
                }
            );
        }

        function handleStatChange(e) {
            const button = e.target.closest('button');
            if (!button || button.disabled) return;
            const statKey = button.dataset.stat;
            const operation = button.dataset.op;
            if (!statKey || !operation) return;
            state.currentStatIndices[statKey] += (operation === 'increase' ? 1 : -1);
            console.log(`Stat Change: ${statKey} ${operation}. New index: ${state.currentStatIndices[statKey]}`);
            saveState();
            renderTrackerScreen();
        }

        function handleHauntToggle() {
            state.hauntStarted = hauntToggle.checked;
            console.log(`Haunt status changed to: ${state.hauntStarted}`);
            saveState();
            renderTrackerScreen();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('--- App Initializing ---');
            const savedStateJSON = localStorage.getItem(STORAGE_KEY);

            if (savedStateJSON) {
                console.log('Found saved state in localStorage:', savedStateJSON);
                try {
                    const parsedState = JSON.parse(savedStateJSON);
                    if (parsedState && typeof parsedState.selectedCharacterIndex === 'number' && parsedState.currentStatIndices) {
                        state = parsedState;
                        console.log('State successfully loaded. Rendering tracker screen.');
                        renderTrackerScreen();
                    } else {
                        console.warn('Saved data is invalid. Resetting state.');
                        resetApp();
                    }
                } catch (e) {
                    console.error('Error parsing saved state. Resetting.', e);
                    resetApp();
                }
            } else {
                console.log('No saved state found. Rendering selection screen.');
                renderSelectionScreen();
            }

            characterList.addEventListener('click', handleCharacterSelection);
            backButton.addEventListener('click', handleBackToSelection);
            statsContainer.addEventListener('click', handleStatChange);
            hauntToggle.addEventListener('change', handleHauntToggle);
            resetAppButton.addEventListener('click', () => {
                showModal(
                    "确定要重置所有进度吗？此操作无法撤销。",
                    resetApp
                );
            });
            modalCancel.addEventListener('click', hideModal);
        });

    </script>
</body>
</html>
